@page "/portfolio"
@inject LocalizationService L
@inject TattooDataService TattooService
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Portfolio - Klod Tattoo Studio</PageTitle>

<div class="container py-5">
    <!-- Header Section -->
    <div class="text-center mb-5" data-aos="fade-up">
        <h1 class="display-4 text-uppercase" style="color: #d4af37;">I Miei Lavori</h1>
        <p class="lead text-muted">Scopri alcuni dei tatuaggi che ho realizzato</p>
        <div style="width: 60px; height: 3px; background-color: #d4af37; margin: 20px auto;"></div>
    </div>

    <!-- FILTRI -->
    <div class="text-center mb-4" data-aos="fade-up" data-aos-delay="100">
        @foreach (var category in categories)
        {
            <button @onclick="() => FilterByCategory(category.Id)" 
                    class="btn btn-outline-light btn-sm me-2 mb-2 filter-btn @(selectedCategory == category.Id ? "active" : "")"
                    style="transition: all 0.3s ease;">
                @category.GetName(L.CurrentCulture)
            </button>
        }
    </div>

    @if (loading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Caricamento...</span>
            </div>
        </div>
    }
    else if (filteredTattoos.Any())
    {
        <!-- Portfolio Grid -->
        <div class="row g-4 portfolio-container">
            @foreach (var tattoo in filteredTattoos)
            {
                <div class="col-md-4 col-lg-3 portfolio-item" data-aos="zoom-in">
                    <div class="position-relative overflow-hidden rounded shadow-sm" style="height: 300px; cursor: pointer;">
                        
                        <!-- Link per GLightbox -->
                        <a href="@tattoo.ImageUrl" class="glightbox" data-gallery="tattoo-gallery" data-title="@tattoo.Title">
                            <img src="@tattoo.ImageUrl" class="w-100 h-100" alt="@tattoo.Title" loading="lazy"
                                 style="object-fit: cover; transition: transform 0.6s ease;">
                        </a>

                        <div class="portfolio-overlay position-absolute top-0 start-0 w-100 h-100
                                    d-flex flex-column justify-content-center align-items-center text-center p-3"
                             style="background: rgba(0,0,0,0.85); opacity: 0; transition: opacity 0.4s ease;">
                            <h5 class="text-uppercase mb-2" style="color: #d4af37;">@tattoo.Title</h5>
                            <p class="text-white small mb-3">@GetCategoryName(tattoo.Category)</p>
                            <button class="btn btn-outline-light btn-sm rounded-0 px-4" @onclick="() => ViewDetails(tattoo.Id)">
                                Dettagli
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <i class="fas fa-image" style="font-size: 4rem; color: var(--secondary-text); margin-bottom: 1rem;"></i>
            <p class="text-muted" style="font-size: 1.1rem;">Nessun tatuaggio trovato in questa categoria.</p>
        </div>
    }
</div>

<style>
    .portfolio-item:hover img {
        transform: scale(1.12);
    }

    .portfolio-item:hover .portfolio-overlay {
        opacity: 1 !important;
    }

    .filter-btn.active {
        background-color: #d4af37 !important;
        color: #1e1e1e !important;
        border-color: #d4af37 !important;
    }

    .filter-btn:hover {
        background-color: rgba(212, 175, 55, 0.3);
        border-color: #d4af37;
    }

    .portfolio-overlay button:hover {
        background-color: #fff;
        color: #000;
    }
</style>

@code {
    private List<TattooCategory> categories = new();
    private List<TattooItem> allTattoos = new();
    private List<TattooItem> filteredTattoos = new();
    private string selectedCategory = "all";
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        L.OnLanguageChanged += OnLanguageChanged;
    }

    private async Task LoadData()
    {
        loading = true;
        StateHasChanged();

        var data = await TattooService.GetDataAsync();
        categories = data.Categories;
        allTattoos = data.Tattoos;
        filteredTattoos = allTattoos;

        loading = false;
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Give GLightbox library time to load
            await Task.Delay(500);
            try
            {
                await JS.InvokeVoidAsync("initGLightbox");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing GLightbox on first render: {ex.Message}");
            }
        }
    }

    private async Task FilterByCategory(string category)
    {
        selectedCategory = category;
        if (category == "all" || string.IsNullOrEmpty(category))
        {
            filteredTattoos = allTattoos;
        }
        else
        {
            filteredTattoos = allTattoos.Where(t => t.Category.Equals(category, StringComparison.OrdinalIgnoreCase)).ToList();
        }
        
        // Force UI update first
        StateHasChanged();

        // Wait for DOM to update, then reinitialize lightbox
        await Task.Delay(200);
        try
        {
            await JS.InvokeVoidAsync("initGLightbox");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing GLightbox: {ex.Message}");
        }
    }

    private string GetCategoryName(string categoryId)
    {
        var category = categories.FirstOrDefault(c => c.Id.Equals(categoryId, StringComparison.OrdinalIgnoreCase));
        return category?.GetName(L.CurrentCulture) ?? categoryId;
    }

    private void ViewDetails(int id)
    {
        // In un sito statico, possiamo semplicemente non fare nulla o mostrare un messaggio
        // Il GLightbox gestisce gi√† la visualizzazione delle immagini
    }

    private void OnLanguageChanged()
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        L.OnLanguageChanged -= OnLanguageChanged;
    }
}
